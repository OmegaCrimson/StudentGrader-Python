name: Manual Versioned Release Pipeline

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without pushing or releasing'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Clean previous outputs
      run: rm -rf dist/ build/ __pycache__ *.spec StudentGrader.zip

    - name: Build executable
      run: pyinstaller --onefile main.py

    - name: Verify build output
      run: |
        if [ ! -f "dist/main.exe" ]; then
          echo "Build failed: dist/main.exe not found."
          exit 1
        fi
        echo "Build succeeded: dist/main.exe found."

    - name: Zip build
      run: |
        zip -r StudentGrader.zip dist/
        echo "Zipped build: StudentGrader.zip"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: StudentGrader-Windows
        path: dist/

    - name: Install GitHub CLI
      run: sudo apt-get install gh

    - name: Create GitHub Release
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "Detecting latest Git tag..."
        TAG=$(git describe --tags --abbrev=0 || echo "")
        echo "Latest tag: $TAG"

        if [ -z "$TAG" ]; then
          echo "No tag found. Skipping release."
          exit 0
        fi

        NOTES_FILE="CHANGELOG.md"
        if [ ! -f "$NOTES_FILE" ]; then
          echo "CHANGELOG.md not found. Creating placeholder."
          echo "Initial release." > "$NOTES_FILE"
        fi

        echo "Creating release for tag: $TAG"
        echo "Repository: $GITHUB_REPOSITORY"
        echo "Artifacts: dist/main.exe, StudentGrader.zip"

        if [ ! -f "dist/main.exe" ] || [ ! -f "StudentGrader.zip" ]; then
          echo "Missing release files. Aborting upload."
          exit 1
        fi

        gh release create "$TAG" dist/main.exe StudentGrader.zip \
          --repo "$GITHUB_REPOSITORY" \
          --title "Student Grader $TAG" \
          --notes-file "$NOTES_FILE" \
          --target main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}